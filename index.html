<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>社區管理費小幫手 (權限與功能修復版)</title>
    
    <!-- 1. CSS (Tailwind) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React 核心 (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Babel 編譯器 -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Firebase (Compat Mode) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #4f46e5; width: 32px; height: 32px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Toast Animation */
        .toast-enter { transform: translateY(100%); opacity: 0; }
        .toast-enter-active { transform: translateY(0); opacity: 1; transition: all 300ms ease-out; }
        .toast-exit { transform: translateY(0); opacity: 1; }
        .toast-exit-active { transform: translateY(100%); opacity: 0; transition: all 300ms ease-in; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="root">
        <div style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <div class="loader" style="margin-bottom: 20px;"></div>
            <h2 style="font-size: 1.25rem; font-weight: bold; color: #374151;">系統啟動中...</h2>
            <div id="error-message" style="margin-top:20px; color:red; font-size:0.9rem;"></div>
        </div>
    </div>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            document.getElementById('error-message').innerText = `發生錯誤: ${msg}`;
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Icons ---
        const Icons = {
            Building2: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></svg>,
            Car: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><path d="M9 17h6"/><circle cx="17" cy="17" r="2"/></svg>,
            Settings: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l.43.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            ClipboardList: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>,
            PieChart: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>,
            LayoutGrid: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>,
            Grid: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>,
            Calendar: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
            Cloud: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.5 19c0-1.7-1.3-3-3-3h-1.1c-.2-1.7-1.7-3-3.4-3H10c-2.2 0-4 1.8-4 4v1c0 1.1.9 2 2 2h9.5c1.4 0 2.5-1.1 2.5-2.5Z"/></svg>,
            WifiOff: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="2" x2="22" y1="2" y2="22"/><path d="M8.5 8.5A6 6 0 0 1 19 12"/><path d="M5 12a10 10 0 0 1 5.83-8.9"/><path d="M5 12.5a10 10 0 0 0 .21 2.05"/></svg>,
            Plus: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Trash2: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Trash: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Pencil: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>,
            Edit: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
            Save: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            X: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            CheckCircle2: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>,
            Check: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            XCircle: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>,
            Link: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
            Clock: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Layers: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></svg>,
            Wand2: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72Z"/><path d="m14 7 3 3"/><path d="M5 6v4"/><path d="M19 14v4"/><path d="M10 2v2"/><path d="M7 8H3"/><path d="M21 16h-4"/></svg>,
            Wand: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72Z"/><path d="m14 7 3 3"/><path d="M5 6v4"/><path d="M19 14v4"/><path d="M10 2v2"/><path d="M7 8H3"/><path d="M21 16h-4"/></svg>,
            ChevronDown: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>,
            ChevronUp: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m18 15-6-6-6 6"/></svg>,
            ChevronRight: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>,
            Download: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            WifiOff: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="2" x2="22" y1="2" y2="22"/><path d="M8.5 8.5A6 6 0 0 1 19 12"/><path d="M5 12a10 10 0 0 1 5.83-8.9"/><path d="M5 12.5a10 10 0 0 0 .21 2.05"/></svg>,
            Eye: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>,
            Lock: (p)=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Upload: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
        };

        const CommunityFeeManager = () => {
            const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'community_manager_v20_final';
            const firebaseConfig = { apiKey: "AIzaSyAJ_b9BiX1zT7WFu8f08uoKxeV8vgDUHz4", authDomain: "fuktrip.firebaseapp.com", projectId: "fuktrip", storageBucket: "fuktrip.firebasestorage.app", messagingSenderId: "663462561018", appId: "1:663462561018:web:d0c9f00c9fed0253a2b543", measurementId: "G-KME94X3EKH" };

            // Mock Data
            const initialUnits = [
                { id: 'u1', name: '78號9樓之2', code: '7892', frequency: '2' },
                { id: 'u2', name: '78號10樓', code: '7810', frequency: '12' },
                { id: 'u3', name: '80號3樓之1', code: '8031', frequency: '3' }
            ];
            const initialParking = [
                { id: 'p1', name: 'B1-10', code: 'B1100', linkedUnitId: 'u1', frequency: '2' },
                { id: 'p2', name: 'B2-05', code: 'B2050', linkedUnitId: '', frequency: '2' }
            ];

            // States
            const [isOffline, setIsOffline] = useState(true);
            const [units, setUnits] = useState(() => JSON.parse(localStorage.getItem('units')) || initialUnits);
            const [parkingSpots, setParkingSpots] = useState(() => JSON.parse(localStorage.getItem('parkingSpots')) || initialParking);
            const [paymentRecords, setPaymentRecords] = useState(() => JSON.parse(localStorage.getItem('paymentRecords_v2') || '{}'));
            const [archivedReports, setArchivedReports] = useState(() => JSON.parse(localStorage.getItem('archivedReports') || '{}'));
            
            // UI States
            const [activeTab, setActiveTab] = useState('report');
            const [reportCategory, setReportCategory] = useState('unit');
            const [reportViewMode, setReportViewMode] = useState('live');
            const [showStats, setShowStats] = useState(false);
            const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
            const [selectedBatch, setSelectedBatch] = useState(new Date().getMonth() + 1); // Default to current month
            
            const [expandedGroups, setExpandedGroups] = useState(new Set());
            const [expandedSubGroups, setExpandedSubGroups] = useState(new Set());

            const [editingUnitId, setEditingUnitId] = useState(null);
            const [editingParkingId, setEditingParkingId] = useState(null);
            
            const [unitForm, setUnitForm] = useState({ building: '78', floor: '', suffix: '', code: '', frequency: '2' });
            const [parkingForm, setParkingForm] = useState({ floor: 'B1', number: '', code: '', linkedUnitId: '', frequency: '2' });

            const [showImportModal, setShowImportModal] = useState(false);
            const [importType, setImportType] = useState('unit');
            const [importText, setImportText] = useState('');
            
            const [showClearModal, setShowClearModal] = useState(false);
            const [clearTarget, setClearTarget] = useState(null); 
            const [clearPassword, setClearPassword] = useState('');

            const [showDeleteModal, setShowDeleteModal] = useState(false);
            const [deleteTarget, setDeleteTarget] = useState(null);

            const [showConfirmModal, setShowConfirmModal] = useState(false);
            const [toastMsg, setToastMsg] = useState('');

            // --- Helpers ---
            const showToast = (msg) => { setToastMsg(msg); setTimeout(() => setToastMsg(''), 2000); };
            const safeCopy = (text) => {
                if(!text) return;
                const ta = document.createElement("textarea"); ta.value = text; document.body.appendChild(ta); ta.select();
                try { document.execCommand('copy'); showToast('已複製!'); } catch (e) { console.error('Copy failed', e); }
                document.body.removeChild(ta);
            };
            const getFreqLabel = (f) => ({'2':'雙月','3':'季','6':'半年','12':'年'}[f]||'雙月');
            const getFreqBadge = (f) => {
                const label = {'2':'雙月繳','3':'季繳','6':'半年繳','12':'年繳'}[f]||'雙月繳';
                const style = {'2':'bg-gray-100 text-gray-600','3':'bg-blue-100 text-blue-600','6':'bg-orange-100 text-orange-600','12':'bg-purple-100 text-purple-600'}[f]||'bg-gray-100 text-gray-600';
                return <span className={`text-[10px] px-1.5 py-0.5 rounded border border-black/5 ml-1 ${style}`}>{label}</span>;
            };
            
            const batches = Array.from({length: 12}, (_, i) => ({ val: i + 1, label: `${i + 1}月` }));
            
            const years = Array.from({length: 2035 - 2025 + 1}, (_, i) => 2025 + i);

            // --- Init ---
            useEffect(() => {
                try {
                    if (localStorage.getItem('units') === null) {
                        setUnits(initialUnits); localStorage.setItem('units', JSON.stringify(initialUnits));
                    }
                    if (localStorage.getItem('parkingSpots') === null) {
                        setParkingSpots(initialParking); localStorage.setItem('parkingSpots', JSON.stringify(initialParking));
                    }
                    setPaymentRecords(JSON.parse(localStorage.getItem('paymentRecords_v2') || '{}'));
                    setArchivedReports(JSON.parse(localStorage.getItem('archivedReports') || '{}'));
                } catch(e) { console.error("Local data corrupted", e); }

                if (window.firebase) {
                    try {
                        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                        const auth = firebase.auth();
                        const db = firebase.firestore();
                        
                        const initAuth = async () => {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await auth.signInWithCustomToken(__initial_auth_token);
                            } else {
                                if (!auth.currentUser) await auth.signInAnonymously();
                            }
                        };
                        
                        initAuth().catch(e => console.warn("Auth init failed, using offline", e));

                        auth.onAuthStateChanged(user => {
                            if (user) {
                                setIsOffline(false);
                                db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('units').onSnapshot(s => {
                                    const d = s.docs.map(doc => ({id:doc.id, ...doc.data()})).sort((a,b)=>a.code.localeCompare(b.code,undefined,{numeric:true}));
                                    if(d.length > 0){ setUnits(d); localStorage.setItem('units',JSON.stringify(d)); }
                                });
                                db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('parkingSpots').onSnapshot(s => {
                                    const d = s.docs.map(doc => ({id:doc.id, ...doc.data()})).sort((a,b)=>a.code.localeCompare(b.code,undefined,{numeric:true}));
                                    if(d.length > 0){ setParkingSpots(d); localStorage.setItem('parkingSpots',JSON.stringify(d)); }
                                });
                                db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('paymentRecords').onSnapshot(s => {
                                    const d = {}; s.docs.forEach(doc => d[doc.id] = doc.data().content);
                                    if(Object.keys(d).length > 0){ setPaymentRecords(d); localStorage.setItem('paymentRecords_v2',JSON.stringify(d)); }
                                });
                                db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('archivedReports').onSnapshot(s => {
                                    const d = {}; s.docs.forEach(doc => d[doc.id] = doc.data());
                                    if(Object.keys(d).length > 0){ setArchivedReports(d); localStorage.setItem('archivedReports',JSON.stringify(d)); }
                                });
                            } else {
                                setIsOffline(true);
                            }
                        });
                    } catch(e) { console.warn("Firebase error", e); setIsOffline(true); }
                }
            }, []);

            // --- Handlers ---
            const save = (type, data, id) => {
                const list = type==='u'?units:parkingSpots;
                const newItem = id ? {...data, id} : {...data, id: Date.now().toString()};
                const newList = id ? list.map(i=>i.id===id?newItem:i) : [...list, newItem];
                if(type==='u'){ setUnits(newList); localStorage.setItem('units',JSON.stringify(newList)); }
                else{ setParkingSpots(newList); localStorage.setItem('parkingSpots',JSON.stringify(newList)); }
                if(!isOffline && firebase.apps.length) {
                    const col = type==='u'?'units':'parkingSpots';
                    const ref = firebase.firestore().collection('artifacts').doc(APP_ID).collection('public').doc('data').collection(col);
                    if(id) ref.doc(id).update(data); else ref.doc(newItem.id).set(data);
                }
                showToast('儲存成功');
            };

            const requestDelete = (type, id) => { setDeleteTarget({ type, id }); setShowDeleteModal(true); };
            const performDelete = () => {
                if (!deleteTarget) return;
                const { type, id } = deleteTarget;
                const list = type==='u'?units:parkingSpots;
                const newList = list.filter(i=>i.id!==id);
                if(type==='u'){ setUnits(newList); localStorage.setItem('units',JSON.stringify(newList)); }
                else{ setParkingSpots(newList); localStorage.setItem('parkingSpots',JSON.stringify(newList)); }
                if(!isOffline && firebase.apps.length) {
                    firebase.firestore().collection('artifacts').doc(APP_ID).collection('public').doc('data').collection(type==='u'?'units':'parkingSpots').doc(id).delete();
                }
                showToast('已刪除'); setShowDeleteModal(false); setDeleteTarget(null);
            };

            const saveDraft = (val) => {
                const k = `${selectedYear}-M${selectedBatch}`; // Changed to M
                const r = {...paymentRecords, [k]:val};
                setPaymentRecords(r); localStorage.setItem('paymentRecords_v2',JSON.stringify(r));
                if(!isOffline && firebase.apps.length) firebase.firestore().collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('paymentRecords').doc(k).set({content:val});
            };

            const handleArchiveClick = () => setShowConfirmModal(true);
            const archiveReport = () => {
                const key = `${selectedYear}-M${selectedBatch}`; // Changed to M
                const content = paymentRecords[key] || '';
                const archiveData = { content, timestamp: Date.now(), savedBy: 'Admin' };
                const newArchives = { ...archivedReports, [key]: archiveData };
                setArchivedReports(newArchives); localStorage.setItem('archivedReports', JSON.stringify(newArchives));
                if(!isOffline && firebase.apps.length) {
                    firebase.firestore().collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('archivedReports').doc(key).set(archiveData);
                }
                setReportViewMode('archived'); setShowConfirmModal(false); showToast('已存檔為正式報表');
            };

            const downloadCSV = () => {
                let csv = "\uFEFF" + (reportCategory==='unit'?"名稱,代碼,頻率,":"名稱,代碼,綁定/頻率,") + "1月,2月,3月,4月,5月,6月,7月,8月,9月,10月,11月,12月\n";
                (reportCategory==='unit'?units:parkingSpots).forEach(i => {
                    const pd = yearly[i.id];
                    let ex = '';
                    if (reportCategory==='unit') { ex = getFreqLabel(i.frequency); } else { const linkName = units.find(u=>u.id===i.linkedUnitId)?.name||'無'; const freqLabel = getFreqLabel(i.frequency); ex = `${linkName} (${freqLabel})`; }
                    csv += `"${i.name}","${i.code}","${ex}",` + Array.from({length:12}).map((_,x)=>pd.has(x+1)?'已繳':'').join(',') + "\n";
                });
                const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download = `${selectedYear}_${reportCategory}.csv`; a.click();
            };

            const exportData = (type) => {
                const data = type === 'unit' ? units : parkingSpots;
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = type === 'unit' ? `units_backup_${Date.now()}.json` : `parking_backup_${Date.now()}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast("已匯出 JSON 備份");
            };

            // --- Clear Functions ---
            const handleClearRequest = (type) => { setClearTarget(type); setClearPassword(''); setShowClearModal(true); };
            const performClear = async () => {
                if (clearPassword !== '123456') { alert('密碼錯誤！'); return; }
                const collectionName = clearTarget === 'unit' ? 'units' : 'parkingSpots';
                if (clearTarget === 'unit') { setUnits([]); localStorage.setItem('units', '[]'); } else { setParkingSpots([]); localStorage.setItem('parkingSpots', '[]'); }
                if (!isOffline && firebase.apps.length) {
                    const ref = firebase.firestore().collection('artifacts').doc(APP_ID).collection('public').doc('data').collection(collectionName);
                    const snapshot = await ref.get();
                    const batch = firebase.firestore().batch();
                    snapshot.docs.forEach((doc) => { batch.delete(doc.ref); });
                    await batch.commit();
                }
                setShowClearModal(false); showToast(`已清空所有${clearTarget === 'unit' ? '戶別' : '車位'}資料`);
            };

            // --- Parsing Logic for Import ---
            const parseUnitFromCode = (code) => {
                const s = code.slice(-1); let rem = code.slice(0, -1); let f = ''; let b = '';
                if (rem.length > 0) { const last2 = rem.slice(-2); if (['10','11','12','13','14'].includes(last2)) { f = last2; b = rem.slice(0, -2); } else { f = rem.slice(-1); b = rem.slice(0, -1); } }
                const floorPart = f === '0' ? '' : f + '樓';
                const name = `${b}號${floorPart}${s === '0' ? '' : '之' + s}`;
                return { name, code, building: b, floor: f==='0'?'':f, suffix: s==='0'?'':s, frequency: '2' };
            };
            const parseParkingFromCode = (code) => {
                let temp = code.endsWith('0') ? code.slice(0, -1) : code;
                const m = temp.match(/^(B\d+)(\d+)$/i); let f = 'B1'; let n = temp; 
                if (m) { f = m[1].toUpperCase(); n = m[2]; } else { const m2 = code.match(/^(B\d+)/i); if(m2) f = m2[1].toUpperCase(); }
                return { name: `${f}-${n}`, code, floor: f, number: n, linkedUnitId: '', frequency: '2' };
            };

            const processImport = () => {
                const lines = importText.split(/[\n,]+/).map(s => s.replace(/\s/g, '')).filter(s => s.length > 0);
                let addedCount = 0; let existingCodes = new Set(importType==='unit' ? units.map(u=>u.code) : parkingSpots.map(p=>p.code));
                const newItems = [];
                lines.forEach(code => {
                    if (!existingCodes.has(code)) {
                        newItems.push({ id: Date.now().toString() + Math.random(), ...(importType==='unit'?parseUnitFromCode(code):parseParkingFromCode(code)) });
                        existingCodes.add(code); addedCount++;
                    }
                });
                if (newItems.length > 0) {
                    const list = importType==='unit' ? units : parkingSpots;
                    const updated = [...list, ...newItems];
                    if(importType==='unit'){ setUnits(updated); localStorage.setItem('units',JSON.stringify(updated)); }
                    else{ setParkingSpots(updated); localStorage.setItem('parkingSpots',JSON.stringify(updated)); }
                    if(!isOffline && firebase.apps.length) {
                        const batch = firebase.firestore().batch();
                        newItems.forEach(item => { const ref = firebase.firestore().collection('artifacts').doc(APP_ID).collection('public').doc('data').collection(importType==='unit'?'units':'parkingSpots').doc(item.id); batch.set(ref, item); });
                        batch.commit();
                    }
                }
                showToast(`成功匯入 ${addedCount} 筆`); setShowImportModal(false); setImportText('');
            };
            const openImportModal = (type) => { setImportType(type); setShowImportModal(true); };
            const handleFileSelect = (e) => { const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=ev=>setImportText(ev.target.result); r.readAsText(f); };

            // --- Form Helpers ---
            const handleUnitChange = (f, v) => {
                let ns = { ...unitForm, [f]: v };
                if (f === 'code') {
                    const s = v.slice(-1); let rem = v.slice(0, -1); let fl = ''; let b = '';
                    if (rem.length > 0) { const last2 = rem.slice(-2); if (['10','11','12','13','14'].includes(last2)) { fl = last2; b = rem.slice(0, -2); } else { fl = rem.slice(-1); b = rem.slice(0, -1); } }
                    ns.building = b; ns.floor = fl === '0' ? '' : fl; ns.suffix = s === '0' ? '' : s;
                } else {
                    const b = f === 'building' ? v : unitForm.building;
                    const fl = f === 'floor' ? v : unitForm.floor;
                    const s = f === 'suffix' ? v : unitForm.suffix;
                    ns.code = `${b}${fl?fl:'0'}${s?s:'0'}`;
                }
                setUnitForm(ns);
            };
            const handleParkingChange = (f, v) => {
                let ns = { ...parkingForm, [f]: v };
                if (f === 'floor' || f === 'number') { ns.code = `${f==='floor'?v:parkingForm.floor}${f==='number'?v:parkingForm.number}`; }
                setParkingForm(ns);
            };
            const startEditUnit = (u) => {
                const m = u.name.match(/^(.+)號(?:(\d+)樓)?(?:之(\d+))?$/);
                setUnitForm({ building: m?m[1]:'78', floor: m?m[2]||'':'', suffix: m?m[3]||'':'', code: u.code, frequency: u.frequency||'2' });
                setEditingUnitId(u.id); window.scrollTo({top:0, behavior:'smooth'});
            };
            const startEditParking = (p) => { 
                const parts = p.name.split('-'); let f = 'B1'; let n = '';
                if (parts.length > 1) { f = parts[0]; n = parts[1]; }
                else { const m = p.name.match(/^(B\d+)[-\s]?(\d+)$/i); if(m) { f = m[1].toUpperCase(); n = m[2]; } else { n = p.name; } }
                setParkingForm({ floor: f, number: n, code: p.code, linkedUnitId: p.linkedUnitId||'', frequency: p.frequency||'2' }); 
                setEditingParkingId(p.id); 
            };
            const cancelEditUnit = () => { setEditingUnitId(null); setUnitForm({building:'78', floor:'', suffix:'', code:'', frequency:'2'}); };
            const cancelEditParking = () => { setEditingParkingId(null); setParkingForm({floor:'B1', number:'', code:'', linkedUnitId:'', frequency:'2'}); };
            const toggle = k => { const s=new Set(expandedGroups); if(s.has(k))s.delete(k);else s.add(k); setExpandedGroups(s); };
            const toggleSub = k => { const s=new Set(expandedSubGroups); if(s.has(k))s.delete(k);else s.add(k); setExpandedSubGroups(s); };

            // --- Grouping ---
            const groupedUnits = useMemo(() => {
                const g={}; units.forEach(u=>{ const m=u.name.match(/^(.+號)/); const k=m?m[1]:'未分類'; if(!g[k])g[k]=[]; g[k].push(u); });
                const keys=Object.keys(g).sort((a,b)=>parseInt(a)-parseInt(b));
                return {g, keys};
            }, [units]);
            
            const getUnitSubGroups = (list) => {
                const sub = {};
                list.forEach(u => { const m = u.name.match(/(\d+)樓/); const f = m ? m[1] + '樓' : '未分類'; if (!sub[f]) sub[f] = []; sub[f].push(u); });
                const keys = Object.keys(sub).sort((a,b) => parseInt(a)||0 - parseInt(b)||0);
                return { sub, keys };
            }

            const groupedParking = useMemo(() => {
                const g={}; parkingSpots.forEach(p=>{ const m=p.name.match(/^(B\d+)/i); const k=m?m[1].toUpperCase():'其它'; if(!g[k])g[k]=[]; g[k].push(p); });
                const keys=Object.keys(g).sort();
                keys.forEach(k=>g[k].sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true})));
                return {g, keys};
            }, [parkingSpots]);

            // --- Calcs ---
            const yearly = useMemo(() => {
                const m={}; units.forEach(u=>m[u.id]=new Set()); parkingSpots.forEach(p=>m[p.id]=new Set());
                
                // Iterate 1-12 months for coverage
                for(let month=1; month<=12; month++){
                    const k = `${selectedYear}-M${month}`;
                    let raw = (reportViewMode === 'archived' ? archivedReports[k]?.content : paymentRecords[k]) || '';
                    const pd=new Set(raw.split(/[\n,]+/).map(s=>s.replace(/\s/g, '')).filter(s=>s.length > 0));
                    
                    units.forEach(u=>{ 
                        if(pd.has(u.code)){ 
                            // Determine coverage based on frequency logic
                            const f = parseInt(u.frequency||'2');
                            let startM = month; 
                            let endM = month;

                            if (f === 12) { // Annual: Pays in any month -> Covers 1-12
                                startM = 1; endM = 12;
                            } else if (f === 6) { // Semi-annual: 1-6 or 7-12
                                if (month <= 6) { startM=1; endM=6; } else { startM=7; endM=12; }
                            } else if (f === 3) { // Quarterly: 1-3, 4-6, ...
                                const q = Math.ceil(month/3);
                                startM = (q-1)*3 + 1; endM = q*3;
                            } else { // Bi-monthly: 1-2, 3-4 ...
                                const b = Math.ceil(month/2);
                                startM = (b-1)*2 + 1; endM = b*2;
                            }
                            
                            for(let i=startM; i<=endM; i++) m[u.id].add(i);
                        }
                    });

                    parkingSpots.forEach(p=>{
                         if(pd.has(p.code)){ 
                             const f = parseInt(p.frequency||'2');
                             let startM = month; let endM = month;
                             if (f === 12) { startM=1; endM=12; }
                             else if (f === 6) { if(month<=6){startM=1;endM=6;}else{startM=7;endM=12;} }
                             else if (f === 3) { const q=Math.ceil(month/3); startM=(q-1)*3+1; endM=q*3; }
                             else { const b=Math.ceil(month/2); startM=(b-1)*2+1; endM=b*2; }

                             for(let i=startM; i<=endM; i++) m[p.id].add(i);
                         }
                    });
                }
                
                parkingSpots.forEach(p=>{ 
                    if(p.linkedUnitId && m[p.linkedUnitId]) {
                        m[p.linkedUnitId].forEach(month => m[p.id].add(month));
                    }
                });
                
                return m;
            }, [units, parkingSpots, paymentRecords, archivedReports, selectedYear, reportViewMode]);

            // --- Current View Logic (With Payment Label Generation) ---
            const getPaymentStatus = (item, currentBatch, allRecords, unitsMap) => {
                // target range for current batch (Now it's single month)
                const targetM = currentBatch;

                const checkBatch = (b, code) => {
                    const k = `${selectedYear}-M${b}`;
                    const raw = allRecords[k] || '';
                    const codes = new Set(raw.split(/[\n,]+/).map(s=>s.replace(/\s/g, '')).filter(s=>s));
                    return codes.has(code);
                }

                // Check self payment in any month (1-12)
                for (let b = 1; b <= 12; b++) { 
                    if (checkBatch(b, item.code)) {
                        // Calculate coverage range for this payment
                        const f = parseInt(item.frequency||'2');
                        let startM = b; let endM = b;

                        if (f===12) { startM=1; endM=12; }
                        else if (f===6) { if(b<=6){startM=1;endM=6;}else{startM=7;endM=12;} }
                        else if (f===3) { const q=Math.ceil(b/3); startM=(q-1)*3+1; endM=q*3; }
                        else { const q=Math.ceil(b/2); startM=(q-1)*2+1; endM=q*2; }
                        
                        // Check if this payment covers current target month
                        if (targetM >= startM && targetM <= endM) {
                             const fLabel = {'2':'雙月','3':'季','6':'半年','12':'年'}[item.frequency]||'雙月';
                             return { isPaid: true, label: `${fLabel}繳 (${startM}-${endM}月)` };
                        }
                    }
                }

                // Check Linked Unit
                if (item.linkedUnitId) {
                    const unit = unitsMap[item.linkedUnitId];
                    if (unit) {
                         for (let b = 1; b <= 12; b++) {
                            if (checkBatch(b, unit.code)) {
                                // Calculate unit coverage range
                                const f = parseInt(unit.frequency||'2');
                                let startM = b; let endM = b;
                                if (f===12) { startM=1; endM=12; }
                                else if (f===6) { if(b<=6){startM=1;endM=6;}else{startM=7;endM=12;} }
                                else if (f===3) { const q=Math.ceil(b/3); startM=(q-1)*3+1; endM=q*3; }
                                else { const q=Math.ceil(b/2); startM=(q-1)*2+1; endM=q*2; }

                                if (targetM >= startM && targetM <= endM) {
                                    const fLabel = {'2':'雙月','3':'季','6':'半年','12':'年'}[unit.frequency]||'雙月';
                                    return { isPaid: true, label: `連動: ${unit.name} ${fLabel}繳(${startM}-${endM}月)` };
                                }
                            }
                        }
                    }
                }
                return { isPaid: false, label: '' };
            };

            const currentView = useMemo(() => {
                const key = `${selectedYear}-M${selectedBatch}`;
                
                let recordsToUse = {};
                for (let b=1; b<=12; b++) {
                    const k = `${selectedYear}-M${b}`;
                    if (reportViewMode === 'archived') {
                        recordsToUse[k] = archivedReports[k]?.content || paymentRecords[k] || '';
                    } else {
                        recordsToUse[k] = paymentRecords[k] || '';
                    }
                }

                const unitsMap = units.reduce((acc, u) => ({...acc, [u.id]: u}), {});
                const list = reportCategory === 'unit' ? units : parkingSpots;
                
                const proc = list.map(item => {
                    const status = getPaymentStatus(item, selectedBatch, recordsToUse, unitsMap);
                    return { ...item, ...status };
                });

                const paid = proc.filter(i=>i.isPaid);
                const unpaid = proc.filter(i=>!i.isPaid);

                return { 
                    paid, unpaid, 
                    stats: { total: proc.length, paid: paid.length, unpaid: unpaid.length, progress: proc.length ? Math.round(paid.length/proc.length*100) : 0 },
                    hasArchive: !!archivedReports[key], archiveTime: archivedReports[key]?.timestamp, 
                    isDraftDifferent: (paymentRecords[key] || '') !== (archivedReports[key]?.content || '')
                };
            }, [reportCategory, units, parkingSpots, selectedYear, selectedBatch, paymentRecords, archivedReports, reportViewMode]);

            // --- Form Submit Wrappers ---
            const onParkingSubmit = (e) => { e.preventDefault(); const name = `${parkingForm.floor}-${parkingForm.number}`; save('p', { name, code: parkingForm.code, linkedUnitId: parkingForm.linkedUnitId, frequency: parkingForm.frequency }, editingParkingId); setEditingParkingId(null); setParkingForm({ floor: 'B1', number: '', code: '', linkedUnitId: '', frequency: '2' }); };
            const onUnitSubmit = (e) => { e.preventDefault(); const fp = unitForm.floor ? unitForm.floor+'樓' : ''; const name = `${unitForm.building}號${fp}${unitForm.suffix?'之'+unitForm.suffix:''}`; save('u', {name, code:unitForm.code, frequency:unitForm.frequency}, editingUnitId); setEditingUnitId(null); setUnitForm(p=>({...p, floor:'', suffix:'', code:''})); };

            return (
                <div className="pb-20 min-h-screen bg-gray-50">
                    <div className={`fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all transform ${toastMsg ? 'translate-y-0 opacity-100' : 'translate-y-10 opacity-0'}`}>{toastMsg}</div>
                    
                    {/* Confirm Modal */}
                    {showConfirmModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-2xl p-6 max-w-sm w-full mx-4 shadow-xl">
                                <h3 className="text-lg font-bold text-gray-800 mb-2">確認存檔？</h3>
                                <p className="text-gray-600 text-sm mb-6">將鎖定本期紀錄為正式報表。</p>
                                <div className="flex justify-end gap-2"><button onClick={()=>setShowConfirmModal(false)} className="px-4 py-2 rounded text-gray-500 hover:bg-gray-100">取消</button><button onClick={archiveReport} className="px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">確定</button></div>
                            </div>
                        </div>
                    )}

                    {/* Delete Confirm Modal */}
                    {showDeleteModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-2xl p-6 max-w-sm w-full mx-4 shadow-xl">
                                <h3 className="text-lg font-bold text-red-600 mb-2">確認刪除？</h3>
                                <p className="text-gray-600 text-sm mb-6">此動作無法復原。</p>
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => { setShowDeleteModal(false); setDeleteTarget(null); }} className="px-4 py-2 rounded text-gray-500 hover:bg-gray-100">取消</button>
                                    <button onClick={performDelete} className="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700 font-bold">刪除</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Clear Modal */}
                    {showClearModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-2xl p-6 max-w-sm w-full mx-4 shadow-xl">
                                <h3 className="text-lg font-bold text-red-600 mb-2">⚠️ 清除所有{clearTarget === 'unit' ? '戶別' : '車位'}資料</h3>
                                <p className="text-gray-600 text-sm mb-4">此動作無法復原！請輸入密碼以確認。</p>
                                <input type="password" value={clearPassword} onChange={e => setClearPassword(e.target.value)} className="w-full border p-2 rounded mb-4" placeholder="輸入密碼" autoComplete="new-password"/>
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setShowClearModal(false)} className="px-4 py-2 rounded text-gray-500 hover:bg-gray-100">取消</button>
                                    <button onClick={performClear} className="px-4 py-2 rounded bg-red-600 text-white font-bold hover:bg-red-700">確認清除</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Import Modal */}
                    {showImportModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-2xl p-6 max-w-lg w-full mx-4 shadow-xl flex flex-col h-[80vh]">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold text-gray-800">匯入{importType === 'unit' ? '戶別' : '車位'}資料</h3>
                                    <button onClick={() => setShowImportModal(false)}><Icons.X size={20}/></button>
                                </div>
                                <p className="text-sm text-gray-500 mb-2">請貼上包含代碼的文字（例如：<code>{importType === 'unit' ? '7841, 7851' : 'B1100, B2050'}</code>），系統會自動解析。</p>
                                <textarea value={importText} onChange={e => setImportText(e.target.value)} className="flex-1 w-full p-4 bg-gray-50 border rounded-xl outline-none resize-none focus:border-indigo-500 mb-4 font-mono text-sm" placeholder="在此貼上代碼..."></textarea>
                                <div className="flex justify-between items-center">
                                    <input type="file" accept=".txt,.csv" onChange={handleFileSelect} className="text-xs text-gray-500 file:mr-2 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                                    <button onClick={processImport} className="px-6 py-2 rounded-lg bg-indigo-600 text-white font-bold hover:bg-indigo-700 flex items-center gap-2"><Icons.Plus size={16}/> 開始匯入</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <header className="bg-white border-b sticky top-0 z-30 shadow-sm h-16 flex items-center px-4 justify-between">
                        <div className="flex items-center gap-2">
                            <div className={`p-2 rounded-lg ${isOffline?'bg-gray-600':'bg-indigo-600'}`}><Icons.Building2 className="text-white" size={20}/></div>
                            <div><h1 className="font-bold text-gray-800">社區小幫手</h1><span className="text-[10px] text-gray-500">{isOffline?'離線':'連線'}</span></div>
                        </div>
                        <div className="flex bg-gray-100 p-1 rounded text-sm">
                            <select value={selectedYear} onChange={e=>setSelectedYear(Number(e.target.value))} className="bg-transparent font-bold outline-none px-1">{years.map(y=><option key={y} value={y}>{y}年</option>)}</select>
                            <select value={selectedBatch} onChange={e=>setSelectedBatch(Number(e.target.value))} className="bg-transparent font-bold text-indigo-700 outline-none px-1">{batches.map(b=><option key={b.val} value={b.val}>{b.label}</option>)}</select>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto px-4 py-6">
                        <div className="flex gap-2 mb-6 overflow-x-auto pb-2 scrollbar-hide">
                            {[{id:'settings',l:'設定',i:Icons.Settings},{id:'input',l:'輸入',i:Icons.ClipboardList},{id:'report',l:'報表',i:Icons.PieChart},{id:'annual',l:'年報',i:Icons.LayoutGrid}].map(t=>(
                                <button key={t.id} onClick={()=>setActiveTab(t.id)} className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap transition-colors ${activeTab===t.id?'bg-white text-indigo-600 shadow-sm':'text-gray-500 hover:bg-gray-200'}`}><t.i size={16}/><span>{t.l}</span></button>
                            ))}
                        </div>

                        {activeTab === 'settings' && (
                            <div className="grid md:grid-cols-2 gap-6">
                                <div className="bg-white rounded-2xl shadow-sm border p-6">
                                    <div className="flex justify-between mb-4">
                                        <h2 className="font-bold flex items-center gap-2"><Icons.Building2 className="text-indigo-500" size={20}/> 戶別設定</h2>
                                        <div className="flex items-center gap-2">
                                            <span className="text-xs bg-gray-100 px-2 py-1 rounded">{units.length}戶</span>
                                            <button onClick={() => exportData('unit')} className="text-xs bg-gray-100 px-2 py-1 rounded flex gap-1"><Icons.Download size={12}/> 匯出</button>
                                            <button onClick={() => openImportModal('unit')} className="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded hover:bg-indigo-100 flex items-center gap-1"><Icons.Plus size={12}/> 匯入</button>
                                            <button onClick={() => handleClearRequest('unit')} className="text-xs bg-red-50 text-red-600 px-2 py-1 rounded hover:bg-red-100 flex items-center gap-1"><Icons.Trash size={12}/></button>
                                        </div>
                                    </div>
                                    <form onSubmit={onUnitSubmit} className={`mb-4 p-4 rounded-xl border ${editingUnitId?'bg-orange-50':'bg-gray-50'}`}>
                                        <div className="grid grid-cols-12 gap-2 mb-3">
                                            <div className="col-span-12 sm:col-span-4 flex"><input required value={unitForm.building} onChange={e=>handleUnitChange('building',e.target.value)} className="w-full border p-2 rounded-l text-sm" placeholder="78"/><span className="bg-gray-200 border-y border-r p-2 rounded-r text-sm">號</span></div>
                                            <div className="col-span-12 sm:col-span-4 flex"><select value={unitForm.floor} onChange={e=>handleUnitChange('floor',e.target.value)} className="w-full border p-2 rounded-l text-sm"><option value="">(無)</option>{Array.from({length:14},(_,i)=>i+1).map(f=><option key={f} value={f}>{f}</option>)}</select><span className="bg-gray-200 border-y border-r p-2 rounded-r text-sm">樓</span></div>
                                            <div className="col-span-12 sm:col-span-4 flex"><span className="bg-gray-200 border-y border-l p-2 rounded-l text-sm">之</span><select value={unitForm.suffix} onChange={e=>handleUnitChange('suffix',e.target.value)} className="w-full border p-2 rounded-r text-sm"><option value="">(無)</option>{[1,2,3,4,5,6].map(s=><option key={s} value={s}>{s}</option>)}</select></div>
                                        </div>
                                        <div className="flex gap-2 mb-3"><select value={unitForm.frequency} onChange={e=>setUnitForm({...unitForm,frequency:e.target.value})} className="w-1/3 border p-2 rounded text-sm"><option value="2">雙月</option><option value="3">季繳</option><option value="6">半年</option><option value="12">年繳</option></select><input value={unitForm.code} onChange={e=>handleUnitChange('code',e.target.value)} className="flex-1 border p-2 rounded text-sm" placeholder="代碼"/></div>
                                        <button className="w-full bg-indigo-600 text-white py-2 rounded text-sm font-bold">{editingUnitId?'儲存修改':'新增'}</button>
                                        {editingUnitId && <button type="button" onClick={cancelEditUnit} className="w-full mt-2 text-xs text-gray-500">取消</button>}
                                    </form>
                                    
                                    <div className="max-h-[400px] overflow-y-auto custom-scrollbar space-y-2">
                                        {groupedUnits.keys.map(buildingKey => {
                                            const buildingUnits = groupedUnits.g[buildingKey];
                                            const subGroups = getUnitSubGroups(buildingUnits);
                                            const isExpanded = expandedGroups.has(`u-${buildingKey}`);
                                            return (
                                                <div key={buildingKey} className="border rounded overflow-hidden">
                                                    <button onClick={()=>toggle('u-'+buildingKey)} className="w-full flex justify-between p-3 bg-gray-50 hover:bg-gray-100 items-center">
                                                        <span className="font-bold text-sm text-gray-700">{buildingKey} <span className="text-xs font-normal text-gray-400 bg-white border px-1 rounded">{buildingUnits.length}戶</span></span>
                                                        {isExpanded ? <Icons.ChevronUp size={16}/> : <Icons.ChevronDown size={16}/>}
                                                    </button>
                                                    {isExpanded && (
                                                        <div className="bg-white border-t p-2 space-y-2">
                                                            {subGroups.keys.map(floorKey => {
                                                                const floorUnits = subGroups.sub[floorKey];
                                                                const isSubExpanded = expandedSubGroups.has(`u-${buildingKey}-${floorKey}`);
                                                                return (
                                                                    <div key={floorKey} className="ml-2 border-l-2 border-indigo-100 pl-2">
                                                                        <button onClick={()=>toggleSub(`u-${buildingKey}-${floorKey}`)} className="flex items-center gap-2 w-full text-left py-1 text-sm font-medium text-gray-600 hover:text-indigo-600">
                                                                             {isSubExpanded ? <Icons.ChevronDown size={12}/> : <Icons.ChevronRight size={12}/>}
                                                                             {floorKey} ({floorUnits.length})
                                                                        </button>
                                                                        {isSubExpanded && (
                                                                            <div className="mt-1 space-y-1">
                                                                                {floorUnits.map(u => (
                                                                                    <div key={u.id} className="flex justify-between p-2 bg-gray-50 rounded hover:bg-indigo-50 group text-xs items-center">
                                                                                        <div><span className="font-bold">{u.name}</span> {getFreqBadge(u.frequency)} <span className="text-gray-400 font-mono ml-1">{u.code}</span></div>
                                                                                        <div className="flex gap-2 opacity-0 group-hover:opacity-100"><button onClick={()=>startEditUnit(u)} className="text-indigo-500"><Icons.Pencil size={14}/></button><button onClick={()=>requestDelete('u',u.id)} className="text-red-500"><Icons.Trash2 size={14}/></button></div>
                                                                                    </div>
                                                                                ))}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>

                                <div className="bg-white rounded-2xl shadow-sm border p-6">
                                    <div className="flex justify-between mb-4">
                                        <h2 className="font-bold flex items-center gap-2"><Icons.Car className="text-emerald-500" size={20}/> 車位設定</h2>
                                        <div className="flex items-center gap-2">
                                            <span className="text-xs bg-gray-100 px-2 py-1 rounded">{parkingSpots.length}位</span>
                                            <button onClick={() => exportData('parking')} className="text-xs bg-gray-100 px-2 py-1 rounded flex gap-1"><Icons.Download size={12}/> 匯出</button>
                                            <button onClick={() => openImportModal('parking')} className="text-xs bg-emerald-50 text-emerald-600 px-2 py-1 rounded hover:bg-emerald-100 flex items-center gap-1"><Icons.Plus size={12}/> 匯入</button>
                                            <button onClick={() => handleClearRequest('parking')} className="text-xs bg-red-50 text-red-600 px-2 py-1 rounded hover:bg-red-100 flex items-center gap-1"><Icons.Trash size={12}/></button>
                                        </div>
                                    </div>
                                    <form onSubmit={onParkingSubmit} className={`mb-4 p-4 rounded-xl border ${editingParkingId?'bg-orange-50':'bg-gray-50'}`}>
                                        <div className="flex gap-2 mb-3">
                                            <div className="w-1/3"><select value={parkingForm.floor} onChange={e=>handleParkingChange('floor',e.target.value)} className="w-full border p-2 rounded text-sm bg-white"><option value="B1">B1</option><option value="B2">B2</option><option value="B3">B3</option></select></div>
                                            <div className="flex-1"><input required value={parkingForm.number} onChange={e=>handleParkingChange('number',e.target.value)} className="w-full border p-2 rounded text-sm" placeholder="號碼 (23)"/></div>
                                        </div>
                                        <div className="flex gap-2 mb-3">
                                            <div className="w-1/3"><input value={parkingForm.code} onChange={e=>setParkingForm({...parkingForm,code:e.target.value})} className="w-full border p-2 rounded text-sm bg-white" placeholder="代碼" /></div>
                                            <div className="flex-1"><select value={parkingForm.frequency} onChange={e=>setParkingForm({...parkingForm,frequency:e.target.value})} className="w-full border p-2 rounded text-sm bg-white"><option value="2">雙月</option><option value="3">季繳</option><option value="6">半年</option><option value="12">年繳</option></select></div>
                                        </div>
                                        <div className="mb-3"><select value={parkingForm.linkedUnitId} onChange={e=>setParkingForm({...parkingForm,linkedUnitId:e.target.value})} className="w-full border p-2 rounded text-sm"><option value="">綁定戶別...</option>{units.map(u=><option key={u.id} value={u.id}>{u.name}</option>)}</select></div>
                                        <button className="w-full bg-emerald-600 text-white py-2 rounded text-sm font-bold">{editingParkingId?'儲存修改':'新增'}</button>
                                        {editingParkingId && <button type="button" onClick={cancelEditParking} className="w-full mt-2 text-xs text-gray-500">取消</button>}
                                    </form>
                                    
                                    <div className="max-h-[400px] overflow-y-auto custom-scrollbar space-y-2">
                                        {groupedParking.keys.map(k=>(
                                            <div key={k} className="border rounded overflow-hidden">
                                                <button onClick={()=>toggle('p-'+k)} className="w-full flex justify-between p-3 bg-gray-50 hover:bg-gray-100"><span className="font-bold text-sm text-gray-700">{k} <span className="text-xs font-normal text-gray-400 bg-white border px-1 rounded">{groupedParking.g[k].length}位</span></span>{expandedGroups.has('p-'+k)?<Icons.ChevronUp size={16}/>:<Icons.ChevronDown size={16}/>}</button>
                                                {expandedGroups.has('p-'+k) && <div className="divide-y border-t">{groupedParking.g[k].map(p=>{ const l=units.find(u=>u.id===p.linkedUnitId); return (
                                                    <div key={p.id} className="flex justify-between items-center p-3 hover:bg-emerald-50 group">
                                                        <div><div className="text-sm font-medium">{p.name} {getFreqBadge(p.frequency)} {l && <span className="text-[10px] text-indigo-500 border bg-white px-1 rounded ml-1">{l.name}</span>}</div><div className="text-xs text-gray-400 font-mono">{p.code}</div></div>
                                                        <div className="flex gap-2 opacity-0 group-hover:opacity-100"><button onClick={()=>startEditParking(p)} className="text-emerald-600"><Icons.Pencil size={16}/></button><button onClick={()=>requestDelete('p',p.id)} className="text-red-500"><Icons.Trash2 size={16}/></button></div>
                                                    </div>
                                                )})}</div>}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* Other Tabs */}
                        {activeTab === 'input' && (
                            <div className="max-w-4xl mx-auto bg-white rounded-2xl shadow border p-6">
                                <h2 className="font-bold text-gray-800 mb-4 border-b pb-2 flex justify-between"><span>費用輸入 <span className="text-sm font-mono bg-indigo-50 px-2 rounded text-indigo-700">{selectedYear}-{selectedBatch}月</span></span><span className="text-xs text-gray-400 font-normal">草稿模式</span></h2>
                                <textarea value={paymentRecords[`${selectedYear}-M${selectedBatch}`]||''} onChange={e=>saveDraft(e.target.value)} className="w-full h-96 border p-4 rounded-xl resize-none outline-none focus:border-indigo-500" placeholder="貼上代碼... (支援空格容錯，例如 78 4 1 會視為 7841)"/>
                                <div className="mt-4 text-right"><button onClick={()=>setActiveTab('report')} className="bg-indigo-600 text-white px-6 py-2 rounded font-bold shadow hover:bg-indigo-700">前往報表預覽</button></div>
                            </div>
                        )}

                        {activeTab === 'report' && (
                            <div className="space-y-6">
                                <div className="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-2xl shadow-sm border">
                                    <div className="flex gap-2">
                                        <button onClick={()=>setReportViewMode('live')} className={`px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 ${reportViewMode==='live'?'bg-blue-100 text-blue-700 ring-2 ring-blue-500':'text-gray-500 hover:bg-gray-100'}`}><Icons.Edit size={16}/> 預覽 (草稿)</button>
                                        <button onClick={()=>setReportViewMode('archived')} className={`px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 ${reportViewMode==='archived'?'bg-indigo-100 text-indigo-700 ring-2 ring-indigo-500':'text-gray-500 hover:bg-gray-100'}`}><Icons.Lock size={16}/> 正式報表 (已存檔)</button>
                                    </div>
                                    <div className="flex gap-2">
                                        {reportViewMode === 'live' && <button onClick={handleArchiveClick} className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-indigo-700 flex items-center gap-2"><Icons.Save size={16}/> 儲存為正式報表</button>}
                                        {reportViewMode === 'archived' && !currentView.hasArchive && <span className="text-sm text-gray-500 italic">尚無存檔紀錄</span>}
                                        {reportViewMode === 'archived' && currentView.hasArchive && <span className="text-sm text-green-600 font-bold flex items-center gap-1"><Icons.CheckCircle2 size={14}/> 已存檔: {new Date(currentView.archiveTime).toLocaleString()}</span>}
                                    </div>
                                </div>
                                {reportViewMode === 'archived' && currentView.hasArchive && currentView.isDraftDifferent && <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded shadow-sm"><div className="flex"><div className="ml-3"><p className="text-sm text-yellow-700">⚠️ 注意：輸入欄位的「草稿」內容與此「正式報表」不同。若要更新報表，請切換至預覽模式並重新儲存。</p></div></div></div>}
                                <div className="flex justify-center bg-white border p-1 rounded-xl w-fit mx-auto shadow-sm"><button onClick={()=>setReportCategory('unit')} className={`px-6 py-2 rounded-lg text-sm font-bold ${reportCategory==='unit'?'bg-indigo-600 text-white':'text-gray-500'}`}>戶別</button><button onClick={()=>setReportCategory('parking')} className={`px-6 py-2 rounded-lg text-sm font-bold ${reportCategory==='parking'?'bg-indigo-600 text-white':'text-gray-500'}`}>車位</button></div>
                                <div className="bg-white rounded-2xl border overflow-hidden shadow-sm">
                                    <button onClick={()=>setShowStats(!showStats)} className="w-full flex justify-between p-4 bg-gray-50 hover:bg-gray-100"><div className="flex gap-3 items-center"><div className="p-2 rounded-full bg-indigo-100 text-indigo-600"><Icons.PieChart size={20}/></div><div className="font-bold text-gray-800">本期統計 <span className="text-xs font-normal text-gray-500 ml-2">進度 {currentView.stats.progress}%</span></div></div>{showStats?<Icons.ChevronUp size={20} className="text-gray-400"/>:<Icons.ChevronDown size={20} className="text-gray-400"/>}</button>
                                    {showStats && <div className="p-4 border-t grid grid-cols-3 gap-4"><div className="p-3 border rounded bg-emerald-50 text-center"><div className="text-xs font-bold text-emerald-600">已繳</div><div className="text-xl font-bold text-emerald-800">{currentView.stats.paid}</div></div><div className="p-3 border rounded bg-red-50 text-center"><div className="text-xs font-bold text-red-600">未繳</div><div className="text-xl font-bold text-red-800">{currentView.stats.unpaid}</div></div><button className="border rounded flex flex-col items-center justify-center hover:bg-gray-50" onClick={()=>safeCopy(currentView.unpaid.map(i=>`${i.name}(${i.code})`).join('\n'))}><Icons.ClipboardList size={20} className="text-gray-400 mb-1"/><span className="text-xs font-bold">複製未繳</span></button></div>}
                                </div>
                                <div className="grid md:grid-cols-2 gap-6">
                                    <div className="bg-white rounded-2xl shadow border h-[500px] flex flex-col"><div className="p-3 border-b bg-emerald-50 text-emerald-800 font-bold flex justify-between px-4"><span>已繳費</span><span>{currentView.paid.length}</span></div><div className="flex-1 overflow-y-auto custom-scrollbar">{currentView.paid.map(i=><div key={i.id} className="p-3 border-b flex justify-between hover:bg-emerald-50 px-4"><div><div className="text-sm font-medium">{i.name}</div><div className="text-xs text-gray-500">{i.label || (i.paidByLink&&'連動繳費')}</div></div><span className="text-xs font-mono text-emerald-600 bg-emerald-50 px-2 rounded h-fit">{i.code}</span></div>)}</div></div>
                                    <div className="bg-white rounded-2xl shadow border h-[500px] flex flex-col"><div className="p-3 border-b bg-red-50 text-red-800 font-bold flex justify-between px-4"><span>未繳費</span><span>{currentView.unpaid.length}</span></div><div className="flex-1 overflow-y-auto custom-scrollbar">{currentView.unpaid.map(i=><div key={i.id} className="p-3 border-b flex justify-between hover:bg-red-50 px-4"><div><div className="text-sm font-medium">{i.name}</div>{i.linkedUnitId&&<div className="text-xs text-gray-400">綁定繳費</div>}</div><span className="text-xs font-mono text-red-400 bg-red-50 px-2 rounded h-fit">{i.code}</span></div>)}</div></div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'annual' && (
                            <div className="bg-white rounded-2xl shadow border overflow-hidden">
                                <div className="p-4 border-b flex justify-between items-center"><h2 className="font-bold flex items-center gap-2"><Icons.LayoutGrid className="text-indigo-600" size={20}/> 全年報表 (以存檔為準)</h2><div className="flex gap-2"><button onClick={()=>setReportCategory('unit')} className={`px-3 py-1 rounded text-xs font-bold ${reportCategory==='unit'?'bg-indigo-600 text-white':'bg-gray-100 text-gray-500'}`}>戶別</button><button onClick={()=>setReportCategory('parking')} className={`px-3 py-1 rounded text-xs font-bold ${reportCategory==='parking'?'bg-indigo-600 text-white':'bg-gray-100 text-gray-500'}`}>車位</button><button onClick={downloadCSV} className="ml-2 bg-white border px-3 py-1 rounded text-xs hover:bg-gray-100"><Icons.Download size={12}/> 匯出</button></div></div>
                                <div className="overflow-x-auto"><table className="w-full text-sm text-left"><thead className="bg-gray-100 text-xs uppercase"><tr><th className="px-4 py-2 sticky left-0 bg-white border-r w-32 shadow-sm">名稱</th>{Array.from({length:12}).map((_,i)=><th key={i} className="px-2 py-2 text-center border-l w-12">{i+1}月</th>)}</tr></thead><tbody className="divide-y">{(reportCategory==='unit'?units:parkingSpots).map(i=>{ const pd=yearly[i.id]; return <tr key={i.id} className="hover:bg-gray-50"><td className="px-4 py-2 font-medium sticky left-0 bg-white border-r shadow-sm">{i.name}</td>{Array.from({length:12}).map((_,x)=><td key={x} className="px-2 py-2 text-center border-l">{pd.has(x+1)?<div className="flex justify-center"><div className="w-2 h-2 rounded-full bg-emerald-500"></div></div>:''}</td>)}</tr>})}</tbody></table></div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<CommunityFeeManager />);
    </script>
</body>
</html>
